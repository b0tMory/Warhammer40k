<!DOCTYPE html>
<html lang="en">
<head>
    <title>Warhammer40k</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="main-header">
        <h1>Warhammer 40k</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="map.html">Map</a></li>
                
                
            </ul>
        </nav>
    </header>

    <h2 class="section-title">Select a Mission Map</h2>
    <select id="mySelect" onchange="updateUnits()">
        <option value="">Select</option>
        <option value="1">GW 2025-26</option>
        <option value="2">WTC 2025</option>
    </select>

    <h2 class="section-title">Deployment</h2>
    <select id="deploymentSelect" onchange="updateLayout()">
        <option value="">Select Deployment</option>
    </select>

    <h2 class="section-title">Layout</h2>
    <select id="layoutSelect" onchange="updateImage()">
        <option value="">Select Layout</option>
    </select>

    
    <!-- Making the box for the army list -->
    <div id="ArmyList">
        <div class="labels">
        <h1>Player 1</h1>
        <h2>Army List</h2>
        </div>
        
        <!-- Army selection view -->
        <div id="armySelectionView1">
            <div class="checks" id="checkboxContainer1">
                <!-- Army checkboxes will be generated here -->
            </div>
        </div>

        <!-- Army detail view -->
        <div id="armyDetailView1" style="display: none;">
            <h3 id="armyTitle1"></h3>
            <div id="unitList1">
                <!-- Units for this army -->
            </div>
            <!-- Unit Selection Dropdown -->
            <div style="margin: 10px 0;">
                <select id="unitSelector1">
                    <option value="">Select Unit to Add</option>
                </select>
            </div>
            <button id="addUnitBtn1">Add Unit</button>
            <button id="deleteUnitBtn1">Delete Unit</button>
            <button id="rotateUnitBtn1">Rotate Selected Unit</button>
            <button id="backBtn1">Back</button>
        </div>
    </div>

    <div id="ArmyList2">
        <div class="labels">
        <h1>Player 2</h1>
        <h2>Army List</h2>
        </div>
        
        <!-- Army selection view -->
        <div id="armySelectionView2">
            <div class="checks" id="checkboxContainer2">
                <!-- Army checkboxes will be generated here -->
            </div>
        </div>

        <!-- Army detail view -->
        <div id="armyDetailView2" style="display: none;">
            <h3 id="armyTitle2"></h3>
            <div id="unitList2">
                <!-- Units for this army -->
            </div>
            <!-- Unit Selection Dropdown -->
            <div style="margin: 10px 0;">
                <select id="unitSelector2">
                    <option value="">Select Unit to Add</option>
                </select>
            </div>
            <button id="addUnitBtn2">Add Unit</button>
            <button id="deleteUnitBtn2">Delete Unit</button>
            <button id="rotateUnitBtn2">Rotate Selected Unit</button>
            
            <button id="backBtn2">Back</button>
        </div>
    </div>

    <!-- Optional Image Element to Show Selected Map -->
    <img id="image" src="GW Layouts 2025-2026\GW - Tipping Point - Layout 4.png" style="width:100%; display:block; margin-top:20px;"/>
    
    <script>
    const unitOptions = {
        1: ["Tipping Point", "Sweeping Engagement", "Hammer & Anvil", "Dawn of War", "Crucible of Battle"],
        2: ["search and destroy", "tipping point", "sweeping engagement", "hammer and anvil", "dawn of war", "crucible of battle"]
    };

    const layoutOptions = {
        "tipping point": ["Layout 1", "Layout 2", "Layout 4", "Layout 6", "Layout 7", "Layout 8"],
        "sweeping engagement": ["Layout 3", "Layout 5"],
        "hammer & anvil": ["Layout 1", "Layout 7", "Layout 8"],
        "dawn of war": ["Layout 5"],
        "crucible of battle": ["Layout 1", "Layout 2", "Layout 4", "Layout 6", "Layout 8"],

        // If you use WTC values, add entries like:
        // "drone": [...], "medic": [...], etc.
    };

    const layoutOptions2 = {
        "search and destroy": ["1", "2", "3", "4 - 5", "6", "7", "8"],
        "tipping point": ["1", "2", "3", "4 - 5", "6", "7", "8"],
        "sweeping engagement": ["1", "2", "3", "4 BETA", "5 BETA", "6 BETA"],
        "hammer and anvil": ["1", "2", "3", "4 - 5", "6", "7", "8"],
        "dawn of war": ["1", "2", "3", "4 BETA", "5 BETA", "6 BETA"],
        "crucible of battle": ["1", "2", "3", "4 - 5", "7", "8"],

        // If you use WTC values, add entries like:
        // "drone": [...], "medic": [...], etc.
    };

    function updateUnits() {
        const armySelect = document.getElementById("mySelect");
        const unitSelect = document.getElementById("deploymentSelect");
        const selectedArmy = armySelect.value;

        unitSelect.innerHTML = '<option value="">-- Select Deployment --</option>';
        document.getElementById("layoutSelect").innerHTML = '<option value="">-- Select Layout --</option>';

        if (unitOptions[selectedArmy]) {
            unitOptions[selectedArmy].forEach(unit => {
                const option = document.createElement("option");
                option.value = unit.toLowerCase(); // This will match layoutOptions keys
                option.text = unit;
                unitSelect.appendChild(option);
            });
        }
    }

    function updateLayout() {
        // gets the selected deployment dropdown
        const deploymentSelect = document.getElementById("deploymentSelect");
        // gets the layout dropdown
        const layoutSelect = document.getElementById("layoutSelect");
        // gets the selected deployment value
        const selectedDeployment = deploymentSelect.value;
        // gets the selected mission map
        const map = document.getElementById("mySelect").value;
        
        // clears the layout dropdown
        layoutSelect.innerHTML = '<option value="">-- Select Layout --</option>';
        
        if (map == "1") {
            // If the map is "GW 2025-26", use the first set of
            if (layoutOptions[selectedDeployment]) {
                layoutOptions[selectedDeployment].forEach(layout => {
                    const option = document.createElement("option");
                    option.value = layout;
                    option.text = layout;
                    layoutSelect.appendChild(option);
                });
            }
        } else if (map == "2") {
            // If the map is "WTC 2025", use the second set of
            // If you want to use the second set of layout options based on a different selection
            if (layoutOptions2[selectedDeployment]) {
                layoutOptions2[selectedDeployment].forEach(layout => {
                    const option = document.createElement("option");
                    option.value = layout;
                    option.text = layout;
                    layoutSelect.appendChild(option);
                });
            }
    }
}
    

    const bc = new BroadcastChannel("overlay_channel");

    // updates the image based on the mission map, deployment, and layout selected
function updateImage() {
    // gets the selected mission map
    const map = document.getElementById("mySelect").value;
    // gets the selected deployment
    const deployment = document.getElementById("deploymentSelect").value;
    // gets the selected layout
    const layout = document.getElementById("layoutSelect").value;
    if (map == "1") {
        // If the map is "GW 2025-26", use the first set of
        if (deployment && layout) {
            const imagePath = `GW Layouts 2025-2026/GW - ${deployment} - ${layout}.png`;
            
            // Save to localStorage for overlay page
            localStorage.setItem("overlayImagePath", imagePath);

            document.getElementById("image").src = imagePath;

            // Broadcast to the overlay
            bc.postMessage({ imagePath });
            console.log("Broadcasting image update:", imagePath);
        }
} else if (map == "2") {
        // If the map is "WTC 2025", use the second set of
        if (deployment && layout) {
            // Convert deployment to uppercase for consistency
        const deploymentUpper = deployment.toUpperCase();

            const imagePath = `WTC Layouts 2025/Cards with text/${deploymentUpper} - ${layout}.png`;
            
            // Save to localStorage for overlay page
            localStorage.setItem("overlayImagePath", imagePath);
    
            document.getElementById("image").src = imagePath;

            // Broadcast to the overlay
            bc.postMessage({ imagePath });
            console.log("Broadcasting image update:", imagePath);
        }
    }
}
    </script>

<script>
const mapContainer = document.getElementById("mapContainer");

  // Click only on predefined markers
mapContainer.addEventListener("click", function(e) {
    if (e.target.classList.contains("marker")) {
    const marker = e.target;

    const piece = document.createElement("img");
      piece.src = "piece.png"; // replace with your piece image
    piece.classList.add("piece");

      // Position piece exactly where marker is
    piece.style.top = marker.style.top;
    piece.style.left = marker.style.left;

    mapContainer.appendChild(piece);
    }
});
</script>

<script>
    // Army list data - FIXED: Match the exact keys from army_units.json
    const armyList = [
        "SPACE MARINES", "UltraMarines", "Imperial Fists", "Iron Hands", "Raven Guard",
        "Salamanders", "White Scars", "Genestealer Cults", "Tyranids", "Necrons",
        "Thousand Sons", "Space Wolves", "Dark Angels", "Black Templars", "Blood Angels",
        "Death Guard", "Chaos Demons", "Chaos Knights", "Adeptus Sororitas", "Adeptus Mechanicus",
        "Deathwatch", "Chaos Space Marines", "World Eaters", "Orks", "Aeldari",
        "Grey Knights", "Tau", "Votann", "Imperial Knights", "Drukhari",
        "Imperial Guard", "Custodes"
    ];
    

    let armyUnits = {};

    // FIXED: Load army units and properly initialize UI
    fetch("army_units.json")
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        armyUnits = data;
        console.log("Army units loaded successfully:", armyUnits);
        generateArmyCheckboxes(); // FIXED: Changed from populateFactions() to generateArmyCheckboxes()
    })
    .catch(error => {
        console.error('Failed to load army units:', error);
        // Fallback: still generate checkboxes even if JSON fails to load
        console.log("Generating checkboxes with fallback data");
        generateArmyCheckboxes();
    });

    function populateUnitSelector(player, armyName) {
        const unitSelector = document.getElementById(`unitSelector${player}`);
        unitSelector.innerHTML = '<option value="">Select Unit to Add</option>';

        // FIXED: Try both the exact name and uppercase version
        let unitsData = armyUnits[armyName] || armyUnits[armyName.toUpperCase()];
        
        if (unitsData) {
            unitsData.forEach(unitObj => {
                const option = document.createElement('option');
                // Handle both string and object formats
                if (typeof unitObj === 'string') {
                    option.value = unitObj;
                    option.text = unitObj;
                } else {
                    // Skip "ARMY LISTS" entry and other non-unit entries
                    if (unitObj.name === "ARMY LISTS" || !unitObj.name) {
                        return;
                    }
                    option.value = unitObj.name;
                    option.text = `${unitObj.name}${unitObj.base ? ' (' + unitObj.base + ')' : ''}`;
                }
                unitSelector.appendChild(option);
            });
            console.log(`Populated ${unitsData.length} units for army: ${armyName}`);
        } else {
            console.warn(`No units found for army: ${armyName}. Available armies:`, Object.keys(armyUnits));
        }
    }

    function renderUnits(player, armyName) {
        const unitList = document.getElementById(`unitList${player}`);
        const playerKey = `player${player}`;
        unitList.innerHTML = '';

        armies[playerKey][armyName].forEach(unit => {
            const div = document.createElement('div');
            if (typeof unit === 'string') {
                div.textContent = unit;
            } else {
                div.textContent = `${unit.name} (${unit.base || "?"})`;
            }
            unitList.appendChild(div);
        });
    }

    // Army management - Updated to store unit objects with rotation tracking
    const armies = {
        player1: {},
        player2: {}
    };

    // Initialize armies
    armyList.forEach(army => {
        armies.player1[army] = [];
        armies.player2[army] = [];
    });

    // Generate army checkboxes for both players
    function generateArmyCheckboxes() {
        const container1 = document.getElementById('checkboxContainer1');
        const container2 = document.getElementById('checkboxContainer2');
        
        // Clear existing content
        container1.innerHTML = '';
        container2.innerHTML = '';
        
        armyList.forEach((army, index) => {
            // Player 1
            const label1 = document.createElement('label');
            const checkbox1 = document.createElement('input');
            checkbox1.type = 'checkbox';
            checkbox1.id = `army1_${index + 1}`;
            checkbox1.value = army;
            checkbox1.addEventListener('change', () => handleArmySelection(1, army, checkbox1));
            label1.appendChild(checkbox1);
            label1.appendChild(document.createTextNode(army));
            container1.appendChild(label1);

            // Player 2
            const label2 = document.createElement('label');
            const checkbox2 = document.createElement('input');
            checkbox2.type = 'checkbox';
            checkbox2.id = `army2_${index + 1}`;
            checkbox2.value = army;
            checkbox2.addEventListener('change', () => handleArmySelection(2, army, checkbox2));
            label2.appendChild(checkbox2);
            label2.appendChild(document.createTextNode(army));
            container2.appendChild(label2);
        });
        
        console.log("Army checkboxes generated successfully");
    }

    // Handle army selection
    function handleArmySelection(player, armyName, checkbox) {
        const playerKey = `player${player}`;
        const hasUnits = armies[playerKey][armyName].length > 0;
        
        // If army has units, keep checkbox checked and open detail view
        if (hasUnits) {
            checkbox.checked = true;
            openArmyDetail(player, armyName);
        } else if (checkbox.checked) {
            // If no units and checkbox is checked, open detail view
            openArmyDetail(player, armyName);
        }
        // If no units and checkbox is unchecked, do nothing (allow unchecking empty armies)
    }

    // Open army detail view
    function openArmyDetail(player, armyName) {
        const selectionView = document.getElementById(`armySelectionView${player}`);
        const detailView = document.getElementById(`armyDetailView${player}`);
        const armyTitle = document.getElementById(`armyTitle${player}`);

        selectionView.style.display = 'none';
        detailView.style.display = 'block';
        armyTitle.textContent = armyName;
        renderUnits(player, armyName);
        populateUnitSelector(player, armyName);
    }

    // UPDATED: Render units with click selection functionality
    function renderUnits(player, armyName) {
        const unitList = document.getElementById(`unitList${player}`);
        const playerKey = `player${player}`;
        
        unitList.innerHTML = '';
        armies[playerKey][armyName].forEach((unit, index) => {
            const div = document.createElement('div');
            div.style.cursor = 'pointer';
            div.style.padding = '5px';
            div.style.margin = '2px 0';
            div.style.border = '1px solid #ccc';
            div.style.borderRadius = '3px';
            div.dataset.unitId = unit.id; // Store unit ID for selection
            
            // Handle both old string format and new object format
            const unitText = typeof unit === 'string' ? unit : unit.name;
            div.textContent = unitText;
            
            // Add click handler for unit selection
            div.addEventListener('click', () => selectUnit(player, armyName, unit.id, div));
            
            unitList.appendChild(div);
        });
    }

    // NEW: Track selected units for each player
    const selectedUnits = {
        player1: null,
        player2: null
    };

    // NEW: Select unit functionality
    function selectUnit(player, armyName, unitId, divElement) {
        const unitList = document.getElementById(`unitList${player}`);
        
        // Clear previous selection styling
        Array.from(unitList.children).forEach(child => {
            child.style.backgroundColor = '';
            child.style.color = '';
        });
        
        // Apply selection styling
        divElement.style.backgroundColor = '#007cba';
        divElement.style.color = 'white';
        
        // Store selected unit
        selectedUnits[`player${player}`] = unitId;
        
        console.log(`Selected unit ID: ${unitId} for Player ${player}`);
    }

    //add unit function to use selected unit type
    function addUnit(player, armyName) {
        const playerKey = `player${player}`;
        const unitSelector = document.getElementById(`unitSelector${player}`);
        const selectedUnitType = unitSelector.value;
        
        if (!selectedUnitType) {
            alert('Please select a unit type to add');
            return;
        }
        
        // Count existing units of this type to create unique names
        const existingUnitsOfType = armies[playerKey][armyName].filter(unit => {
            const unitName = typeof unit === 'string' ? unit : unit.name;
            return unitName.startsWith(selectedUnitType);
        });
        
        const unitNumber = existingUnitsOfType.length + 1;
        const unitName = unitNumber === 1 ? selectedUnitType : `${selectedUnitType} ${unitNumber}`;
        
        // Create unit object with rotation tracking
        const newUnit = {
            name: unitName,
            id: Date.now() + Math.random(), // Simple unique ID
            rotation: 0 // Track current rotation (0, 45, 90, 135, 180, 225, 270, 315)
        };
        
        armies[playerKey][armyName].push(newUnit);
        renderUnits(player, armyName);
        
        // Keep the checkbox checked since army now has units
        updateCheckboxState(player, armyName, true);
        
        // Reset unit selector
        unitSelector.value = '';
        
        // Broadcast unit addition to map.html
        const imagePath = player === 1 ? 
            'elements/2.png' : 
            'elements/1.png';
            
        bc.postMessage({ 
            action: 'addUnit',
            player: player,
            unitName: `${armyName} ${unitName}`,
            unitId: newUnit.id,
            imagePath: imagePath,
            rotation: newUnit.rotation
        });
        
        console.log(`Broadcasting unit addition: Player ${player}, Unit: ${armyName} ${unitName}, ID: ${newUnit.id}`);
    }

    // Delete last unit - Updated to handle unit objects
    function deleteLastUnit(player, armyName) {
        const playerKey = `player${player}`;
        const deletedUnit = armies[playerKey][armyName].pop();
        renderUnits(player, armyName);
        
        // Clear selection if deleted unit was selected
        if (selectedUnits[playerKey] && deletedUnit && selectedUnits[playerKey] === deletedUnit.id) {
            selectedUnits[playerKey] = null;
        }
        
        // Update checkbox state based on whether army still has units
        const hasUnits = armies[playerKey][armyName].length > 0;
        updateCheckboxState(player, armyName, hasUnits);
        
        // Broadcast unit deletion to map.html
        if (deletedUnit) {
            const unitName = typeof deletedUnit === 'string' ? deletedUnit : deletedUnit.name;
            bc.postMessage({ 
                action: 'deleteUnit',
                player: player,
                unitName: `${armyName} ${unitName}`
            });
            
            console.log(`Broadcasting unit deletion: Player ${player}, Unit: ${armyName} ${unitName}`);
        }
    }

    // FIXED: New function to rotate only the selected unit
    function rotateSelectedUnit(player, armyName) {
        const playerKey = `player${player}`;
        const selectedUnitId = selectedUnits[playerKey];
        
        if (!selectedUnitId) {
            alert('Please select a unit to rotate by clicking on it in the unit list.');
            return;
        }
        
        // Find the selected unit in the army
        const selectedUnit = armies[playerKey][armyName].find(unit => unit.id === selectedUnitId);
        
        if (!selectedUnit) {
            alert('Selected unit not found. Please select a unit first.');
            return;
        }
        
        // Handle both old string format and new object format
        if (typeof selectedUnit === 'string') {
            // Convert old string format to object format
            const index = armies[playerKey][armyName].indexOf(selectedUnit);
            armies[playerKey][armyName][index] = {
                name: selectedUnit,
                id: selectedUnitId,
                rotation: 45 // Start at 45 degrees for first rotation
            };
            selectedUnit = armies[playerKey][armyName][index];
        } else {
            // Increment rotation by 45 degrees (1/8 of a full rotation)
            selectedUnit.rotation = (selectedUnit.rotation + 45) % 360;
        }
        
        // Broadcast ONLY the selected unit's rotation to map.html
        bc.postMessage({ 
            action: 'rotateUnit',
            player: player,
            armyName: armyName,
            unitId: selectedUnit.id,
            unitName: selectedUnit.name,
            newRotation: selectedUnit.rotation
        });
        
        console.log(`Broadcasting rotation for SELECTED unit ONLY: ${selectedUnit.name} (ID: ${selectedUnit.id}) to ${selectedUnit.rotation}Â°`);
        
        // Visual feedback
        const rotateBtn = document.getElementById(`rotateUnitBtn${player}`);
        const originalText = rotateBtn.textContent;
        rotateBtn.textContent = 'Rotating...';
        rotateBtn.disabled = true;
        
        setTimeout(() => {
            rotateBtn.textContent = originalText;
            rotateBtn.disabled = false;
        }, 300);
    }

    // Update checkbox state
    function updateCheckboxState(player, armyName, checked) {
        const checkboxes = document.querySelectorAll(`#checkboxContainer${player} input[value="${armyName}"]`);
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
    }

    // Go back to army selection
    function goBackToSelection(player) {
        const selectionView = document.getElementById(`armySelectionView${player}`);
        const detailView = document.getElementById(`armyDetailView${player}`);
        
        // Clear selection when going back
        selectedUnits[`player${player}`] = null;
        
        selectionView.style.display = 'block';
        detailView.style.display = 'none';
    }

    // Event listeners for buttons
    document.getElementById('addUnitBtn1').addEventListener('click', () => {
        const armyName = document.getElementById('armyTitle1').textContent;
        addUnit(1, armyName);
    });

    document.getElementById('deleteUnitBtn1').addEventListener('click', () => {
        const armyName = document.getElementById('armyTitle1').textContent;
        deleteLastUnit(1, armyName);
    });

    // UPDATED: Use the new function for individual unit rotation
    document.getElementById('rotateUnitBtn1').addEventListener('click', () => {
        const armyName = document.getElementById('armyTitle1').textContent;
        rotateSelectedUnit(1, armyName);
    });

    document.getElementById('backBtn1').addEventListener('click', () => {
        goBackToSelection(1);
    });

    document.getElementById('addUnitBtn2').addEventListener('click', () => {
        const armyName = document.getElementById('armyTitle2').textContent;
        addUnit(2, armyName);
    });

    document.getElementById('deleteUnitBtn2').addEventListener('click', () => {
        const armyName = document.getElementById('armyTitle2').textContent;
        deleteLastUnit(2, armyName);
    });

    // UPDATED: Use the new function for individual unit rotation
    document.getElementById('rotateUnitBtn2').addEventListener('click', () => {
        const armyName = document.getElementById('armyTitle2').textContent;
        rotateSelectedUnit(2, armyName);
    });

    document.getElementById('backBtn2').addEventListener('click', () => {
        goBackToSelection(2);
    });

    // REMOVED: Don't initialize on DOMContentLoaded since we need to wait for JSON
    // The initialization now happens after the fetch completes
</script>

</body>
</html>